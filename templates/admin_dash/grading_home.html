{# templates/admin_dash/grading_home.html #}
{% extends "admin/base_site.html" %}

{% block content %}
<div class="ce-admin-wrap">

  <h1 style="margin:0 0 14px 0;">Grading – Application 2</h1>

  <!-- ===================== -->
  <!-- Group Filter -->
  <!-- ===================== -->
  <div style="margin-bottom:14px; display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
    <form method="get" action="" style="display:flex; gap:10px; align-items:center;">
      <label for="group" style="font-weight:600;">Group</label>
      <input
        id="group"
        name="group"
        type="text"
        value="{{ group }}"
        placeholder="e.g. 6"
        style="padding:6px 10px; border:1px solid #ccc; border-radius:6px; width:120px;"
      />
      <button class="button" type="submit">Filter</button>

      {% if group %}
        <a class="button" href="/admin/grading/" style="text-decoration:none;">Clear</a>
      {% endif %}
    </form>
  </div>

  <!-- ===================== -->
  <!-- Sandbox CSV Upload -->
  <!-- ===================== -->
  <div style="margin: 0 0 14px 0; padding:12px; border:1px solid #ddd; border-radius:10px; background:#fff;">
    <div style="font-weight:700; margin-bottom:8px;">Test Upload CSV (Sandbox)</div>

    <form
      method="post"
      enctype="multipart/form-data"
      action="{% url 'admin_grading_upload_test_csv' %}{% if group %}?group={{ group }}{% endif %}"
      style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;"
    >
      {% csrf_token %}

      <label style="font-weight:600;">Role:</label>
      <select name="role" style="padding:6px 10px; border:1px solid #ccc; border-radius:6px;">
        <option value="E">Emprendedora (TEST_E_A2)</option>
        <option value="M">Mentora (TEST_M_A2)</option>
      </select>

      <input type="file" name="csv_file" accept=".csv" style="display:inline; width:260px;" />
      <button class="button" type="submit">Upload CSV</button>

      <div style="color:#666; font-size:12px;">
        Imports into sandbox forms only. Real group applications are untouched.
      </div>
    </form>
  </div>

  <!-- ===================== -->
  <!-- Forms Table -->
  <!-- ===================== -->
  <div style="overflow:auto; border:1px solid #ddd; border-radius:10px; background:#fff;">
    <table style="border-collapse:collapse; width:100%; font-size:13px;">
      <thead>
        <tr>
          <th style="padding:10px; border-bottom:1px solid #eee; text-align:left;">Form</th>
          <th style="padding:10px; border-bottom:1px solid #eee; text-align:left;">Total</th>
          <th style="padding:10px; border-bottom:1px solid #eee; text-align:left;">Pending</th>
          <th style="padding:10px; border-bottom:1px solid #eee; text-align:left;">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for f in forms %}
          <tr>
            <td style="padding:10px; border-bottom:1px solid #f0f0f0;">
              <div style="font-weight:700;">{{ f.slug }}</div>
              <div style="color:#666; font-size:12px;">{{ f.name }}</div>
            </td>

            <td style="padding:10px; border-bottom:1px solid #f0f0f0;">
              {{ f.total }}
            </td>

            <td style="padding:10px; border-bottom:1px solid #f0f0f0;">
              {% if f.pending %}
                <strong>{{ f.pending }}</strong>
              {% else %}
                <span style="color:#999;">0</span>
              {% endif %}
            </td>

            <td style="padding:10px; border-bottom:1px solid #f0f0f0; white-space:nowrap;">

              <!-- Download CSV -->
              <a
                class="button"
                style="text-decoration:none;"
                href="{% url 'admin_grading_master_csv' f.slug %}"
              >
                Download Master CSV
              </a>

              <!-- Batch grade -->
              <form
                method="post"
                action="{% url 'admin_grade_form_batch' f.slug %}{% if group %}?group={{ group }}{% endif %}"
                style="display:inline;"
              >
                {% csrf_token %}
                <button class="button" type="submit">
                  Grade (batch)
                </button>
              </form>

              <!-- Live grading (background job) -->
              <form
                method="post"
                action="{% url 'admin_start_grading_job' f.slug %}"
                style="display:inline;"
              >
                {% csrf_token %}
                <button class="button" style="background:#2563eb;color:white;">
                  Grade (live)
                </button>
              </form>

            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" style="padding:16px; text-align:center; color:#666;">
              No A2 forms found.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <p style="margin-top:10px; color:#666; font-size:12px;">
    Batch grading updates the database directly. Live grading creates downloadable graded files and shows progress.
  </p>

  <!-- ===================== -->
  <!-- Graded Files -->
  <!-- ===================== -->
  <h3 style="margin-top:20px;">Graded files</h3>

  <ul>
    {% for f in graded_files %}
      <li>
        {{ f.created_at }} —
        {{ f.form_slug }} —
        app {{ f.application_id }} —
        <a href="{{ f.file.url }}" target="_blank">Download</a>
      </li>
    {% empty %}
      <li>No graded files yet.</li>
    {% endfor %}
  </ul>

</div>
{% endblock %}
