{# applications/templates/applications/application_form.html #}
{% extends "applications/base.html" %}

{% block title %}{{ form_def.name }} ¬∑ Club Emprendo{% endblock %}

{% block content %}

  {% if rendered_description %}
    <div class="form-intro">
      {{ rendered_description|linebreaks }}
    </div>
  {% endif %}

  <div class="ce-form-header">
    <span class="ce-form-pill">
      {% if second_stage %}Paso 2{% else %}Paso 1{% endif %}
    </span>

    <h1 class="ce-form-title ce-heading">{{ form_def.name }}</h1>
    {% if form_def.description %}
      <p class="ce-form-subtitle">{{ form_def.description }}</p>
    {% endif %}
  </div>

  {% if second_stage %}
    <div class="ce-alert">
      ‚úÖ Recuerda hacer clic en ‚ÄúEnviar / Submit‚Äù al final para registrar tu respuesta.
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}

    {% if sections %}
      <div id="ce-stepper" style="display:flex; gap:8px; margin-bottom:16px;">
        {% for section in sections %}
          <div data-stepper-item
               title="{{ section.title }}"
               style="padding:6px 10px; border-radius:999px; background:#f2f4ff; color:#2c3191; font-size:13px; display:flex; align-items:center; gap:6px;">
            <span style="display:inline-block; width:22px; height:22px; border-radius:999px; background:#2c3191; color:#fff; text-align:center; line-height:22px; font-size:12px;">{{ forloop.counter }}</span>
          </div>
        {% endfor %}
      </div>

      <div id="ce-section-container">
        {% for section in sections %}
          <div class="ce-section-panel"
               data-section-index="{{ forloop.counter0 }}"
               style="{% if not forloop.first %}display:none;{% endif %}">
            <div style="margin-bottom:14px;">
              <h2 class="ce-heading" style="margin:0 0 6px 0;">{{ section.title }}</h2>
              {% if section.intro %}
                <p class="ce-muted" style="margin:0;">{{ section.intro|linebreaks }}</p>
              {% endif %}
            </div>

            {% for field in section.fields %}
              {% include "applications/_field_render.html" %}
            {% endfor %}

            <div class="ce-actions" style="margin-top:18px; display:flex; justify-content:space-between; gap:10px;">
              <div>
                {% if not forloop.first %}
                  <button type="button" class="ce-button-primary" data-prev>Anterior</button>
                {% endif %}
              </div>
              <div>
                {% if not forloop.last %}
                  <button type="button" class="ce-button-primary" data-next>Siguiente</button>
                {% else %}
                  <button type="submit" class="ce-button-primary">Enviar</button>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      {% for field in form %}
        {% include "applications/_field_render.html" %}
      {% endfor %}

      <div class="ce-actions">
        <button type="submit" class="ce-button-primary">Enviar</button>
      </div>
    {% endif %}
  </form>

  <script>
    (function () {
      const panels = Array.from(document.querySelectorAll(".ce-section-panel"));
      if (!panels.length) return;

      const stepperItems = Array.from(document.querySelectorAll("[data-stepper-item]"));
      let current = 0;

      function setActive(idx) {
        current = Math.max(0, Math.min(idx, panels.length - 1));
        panels.forEach((p, i) => {
          p.style.display = i === current ? "" : "none";
        });
        stepperItems.forEach((el, i) => {
          el.style.background = i === current ? "#2c3191" : "#f2f4ff";
          el.style.color = i === current ? "#fff" : "#2c3191";
        });

        const header = document.querySelector(".ce-form-header");
        const top = header ? header.offsetTop : 0;
        window.scrollTo({ top: Math.max(top - 10, 0), behavior: "smooth" });
      }

      function findErrorSection() {
        for (let i = 0; i < panels.length; i++) {
          if (panels[i].querySelector(".form-help[style*='color:#d14b4b']")) return i;
        }
        return null;
      }

      panels.forEach((panel, idx) => {
        panel.querySelectorAll("[data-next]").forEach(btn => {
          btn.addEventListener("click", () => setActive(idx + 1));
        });
        panel.querySelectorAll("[data-prev]").forEach(btn => {
          btn.addEventListener("click", () => setActive(idx - 1));
        });
      });

      const errorIdx = findErrorSection();
      setActive(errorIdx !== null ? errorIdx : 0);
    })();

    (function () {
      // üîí Run ONLY for Mentora A2
      if (!window.location.pathname.includes("_M_A2")) return;

      const DRIVER_TEXT = "has dirigido tu propio negocio";
      const TARGET_TEXTS = [
        "industria de tu emprendimiento",
        "nombre de tu emprendimiento",
        "donde operas tu negocio",
        "cuanto tiempo has estado operando",
        "tienes empleados",
        "Descripci√≥n del negocio"
      ];

      function norm(s) {
        return (s || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function findRowByLabelContains(fragment) {
        const frag = norm(fragment);
        const rows = document.querySelectorAll(".form-row");
        for (const row of rows) {
          const label = row.querySelector("label");
          const txt = norm(label ? label.textContent : "");
          if (txt.includes(frag)) return row;
        }
        return null;
      }

      function findRowsByLabelFragments(fragments) {
        const rows = [];
        const all = document.querySelectorAll(".form-row");
        for (const row of all) {
          const label = row.querySelector("label");
          const txt = norm(label ? label.textContent : "");
          for (const f of fragments) {
            if (txt.includes(norm(f))) {
              rows.push(row);
            }
          }
        }
        return rows;
      }

      function getSelectedChoiceText(row) {
        if (!row) return "";

        const sel = row.querySelector("select");
        if (sel) {
          const opt = sel.options[sel.selectedIndex];
          return opt ? opt.textContent.trim() : "";
        }

        const checked = row.querySelector('input[type="radio"]:checked');
        if (checked) {
          const label = checked.closest("label");
          if (label) {
            const clone = label.cloneNode(true);
            clone.querySelectorAll("input").forEach(el => el.remove());
            return clone.textContent.trim();
          }
        }
        return "";
      }

      const driverRow = findRowByLabelContains(DRIVER_TEXT);
      const targetRows = findRowsByLabelFragments(TARGET_TEXTS);

      if (!driverRow || !targetRows.length) return;

      function update() {
        const picked = norm(getSelectedChoiceText(driverRow));
        const show = picked.startsWith("si");
        targetRows.forEach(row => {
          row.style.display = show ? "" : "none";
        });
      }

      update();

      driverRow.querySelectorAll('input[type="radio"]').forEach(el => {
        el.addEventListener("change", update);
      });

      const sel = driverRow.querySelector("select");
      if (sel) sel.addEventListener("change", update);
    })();

    (function () {
      const FOLLOW_TEXT_FRAGMENT = "por favor ind√≠canos qu√© requisito";
      const REQUIREMENTS_SLUG_CANDIDATES = [
        "meets_requirements",
        "m1_meet_requirements",
        "m1_meets_requirements",
        "m1_requirements_ok",
        "requirements_ok",
        "requisitos",
        "requisitos_ok",
      ];

      function norm(s) {
        return (s || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function findRowByLabelContains(fragment) {
        const frag = norm(fragment);
        const rows = document.querySelectorAll(".form-row");
        for (const row of rows) {
          const label = row.querySelector("label");
          const txt = norm(label ? label.textContent : "");
          if (txt.includes(frag)) return row;
        }
        return null;
      }

      function findRowByQuestionSlugCandidates(slugs) {
        for (const slug of slugs) {
          const fieldName = "q_" + slug;

          const byDataField = document.querySelector('.form-row[data-field="' + fieldName + '"]');
          if (byDataField) return byDataField;

          const byName = document.querySelector('.form-row [name="' + fieldName + '"]');
          if (byName) return byName.closest(".form-row");
        }
        return null;
      }

      function setRowVisible(row, show) {
        if (!row) return;
        row.style.display = show ? "" : "none";
      }

      function getSelectedChoiceText(row) {
        if (!row) return "";

        const sel = row.querySelector("select");
        if (sel) {
          const opt = sel.options[sel.selectedIndex];
          return opt ? (opt.textContent || "").trim() : "";
        }

        const checked = row.querySelector('input[type="radio"]:checked');
        if (checked) {
          const choiceLabel = checked.closest("label");
          if (choiceLabel) {
            const clone = choiceLabel.cloneNode(true);
            clone.querySelectorAll("input").forEach(el => el.remove());
            return (clone.textContent || "").trim();
          }
        }

        return "";
      }

      const followRow = findRowByLabelContains(FOLLOW_TEXT_FRAGMENT);
      if (!followRow) return;

      let reqRow = findRowByQuestionSlugCandidates(REQUIREMENTS_SLUG_CANDIDATES);
      if (!reqRow) reqRow = findRowByLabelContains("cumples todos estos requisitos");

      function update() {
        let showFollow = false;
        if (reqRow) {
          const picked = norm(getSelectedChoiceText(reqRow));
          showFollow = picked.startsWith("no");
        }
        setRowVisible(followRow, showFollow);
      }

      update();

      if (reqRow) {
        reqRow.querySelectorAll('input[type="radio"]').forEach((el) => {
          el.addEventListener("change", update);
        });
        const sel = reqRow.querySelector("select");
        if (sel) sel.addEventListener("change", update);
      }
    })();
  </script>

{% endblock %}
