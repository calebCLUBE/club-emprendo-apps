{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="ce-admin-wrap">

  <h1>Master Applications</h1>

  <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:24px;">
    {% for fd in masters %}
      <a class="ce-admin-tile" href="/admin/applications/formdefinition/{{ fd.id }}/change/">
        <div class="ce-admin-tile-title">{{ fd.slug }}</div>
        <div class="ce-admin-tile-sub">{{ fd.name }}</div>
      </a>
    {% empty %}
      <p>No master forms found yet.</p>
    {% endfor %}
  </div>

  <hr style="margin:24px 0;" />

  <h2>Groups</h2>

  <div style="margin-bottom: 18px;">
    <form method="post" action="{% url 'admin_create_group' %}">
      {% csrf_token %}

      {% if create_group_form.non_field_errors %}
        <div class="errornote">
          {{ create_group_form.non_field_errors }}
        </div>
      {% endif %}

      {{ create_group_form.as_p }}

      <button type="submit" class="default">Create group</button>
    </form>
  </div>


  {% for g, forms in group_list %}
    <div style="border:1px solid #ddd; border-radius:10px; padding:14px; margin:14px 0; background:#fff;">

      <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          {% if g.number %}
            <h3 style="margin:0;">
              Group {{ g.number }}
              <small style="color:#666; font-weight:normal;">
                ({{ g.start_day }} {{ g.start_month }} – {{ g.end_month }} {{ g.year }})
              </small>
            </h3>
          {% else %}
            <h3 style="margin:0;">
              Group {{ g }}
              <small style="color:#b45309; font-weight:normal;">
                (orphan group – missing FormGroup dates)
              </small>
            </h3>
          {% endif %}
        </div>

        <div>
            <form
            method="post"
            action="{% url 'admin_delete_group' group_num=g.number|default:g %}"
            style="display:inline;"
            onsubmit="return confirm('Delete Group {{ g.number|default:g }} and ALL its forms? This cannot be undone.');"
          >
            {% csrf_token %}
            <button type="submit" class="deletelink">Delete group</button>
          </form>
        </div>
      </div>

      {% if forms %}
        <ul style="margin-top:10px;">
          {% for fd in forms %}
            <li style="margin:10px 0;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <div>
                  <strong>{{ fd.slug }}</strong>
                  — {{ fd.name }}
                  &nbsp;|&nbsp;
                  <a href="/admin/applications/formdefinition/{{ fd.id }}/change/">Edit</a>
                  &nbsp;|&nbsp;
                  <a href="/apply/{{ fd.slug }}/" target="_blank" rel="noopener">Open link</a>
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                  {# Send reminders button (ONLY for A2) #}
                  {% if fd.slug and "_A2" in fd.slug %}
                    <form method="post" action="{% url 'admin_send_second_stage_reminders' fd.slug %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" class="button"
                        onclick="return confirm('Send reminders for {{ fd.slug }}?');">
                        Send reminders
                      </button>
                    </form>
                  {% endif %}

                  {# Close/Open applications (uses is_public as open flag) #}
                  <form method="post" action="{% url 'admin_toggle_form_open' fd.slug %}" style="display:inline;">
                    {% csrf_token %}
                    {% if fd.is_public %}
                      <button type="submit" class="button"
                        onclick="return confirm('Close {{ fd.slug }} so it stops accepting submissions?');">
                        Close
                      </button>
                    {% else %}
                      <button type="submit" class="button default"
                        onclick="return confirm('Open {{ fd.slug }} so it accepts submissions again?');">
                        Open
                      </button>
                    {% endif %}
                  </form>
                </div>
              </div>

              {# ✅ Copy/paste line removed #}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p style="margin:10px 0 0;"><em>No forms in this group yet.</em></p>
      {% endif %}
      <div style="margin-top:10px; padding:10px; background:#f9f9f9; border-radius:8px;">
        <form method="post" action="{% url 'admin_update_group' group_num=g.number %}" style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
          {% csrf_token %}
          <div>
            <label class="inline">Día de inicio</label><br>
            <input type="number" min="1" max="31" name="start_day" value="{{ g.start_day }}" class="vTextField" style="width:90px;">
          </div>
          <div>
            <label class="inline">Fecha límite A2</label><br>
            <input type="date" name="a2_deadline" value="{{ g.a2_deadline|date:'Y-m-d' }}" class="vDateField">
          </div>
          <div>
            <button type="submit" class="button default">Guardar fechas</button>
          </div>
          <div style="color:#555; font-size:12px;">
            Actualiza sólo las fechas; meses/año permanecen igual.
          </div>
        </form>
      </div>
    </div>
  {% empty %}
    <p>No groups yet.</p>
  {% endfor %}

</div>
{% endblock %}
