<div class="ce-cond-widget" data-questions="{{ widget.questions_json|escape }}">
  <input type="hidden" name="{{ widget.name }}" value="{{ widget.value_json|default:'[]'|escape }}" data-cond-input>
  <p style="margin:0 0 8px 0; color:#555; font-size:12px;">
    esta pregunta se mostrara cuando se cumpla al menos una regla.
    si no agregas reglas, la pregunta se mostrara siempre.
  </p>
  <div data-cond-rows style="display:grid; gap:8px;"></div>
  <button type="button" class="button" data-add-cond>agregar otra regla</button>
</div>

<script>
  (function() {
    const root = document.currentScript?.previousElementSibling;
    if (!root || root.dataset.inited === "1") return;
    root.dataset.inited = "1";

    function parseAttrJSON(raw, fallback) {
      if (!raw) return fallback;
      try { return JSON.parse(raw); } catch (e) {}
      try {
        const normalized = raw
          .replace(/\\u0022/g, "\"")
          .replace(/\\u0027/g, "'")
          .replace(/\\u005C/g, "\\");
        return JSON.parse(normalized);
      } catch (e) {}
      return fallback;
    }

    const questions = parseAttrJSON(root.getAttribute("data-questions"), []);
    const input = root.querySelector("[data-cond-input]");
    const rows = root.querySelector("[data-cond-rows]");

    function buildValueOptions(q) {
      const opts = [];
      opts.push({ value: "", label: "elige una respuesta" });
      if (!q) return opts;
      if (q.field_type === "boolean") {
        opts.push({ value: "yes", label: "si" });
        opts.push({ value: "no", label: "no" });
      } else if (q.field_type === "choice" || q.field_type === "multi_choice") {
        (q.choices || []).forEach(c => opts.push({ value: c.value, label: c.label || c.value }));
      }
      return opts;
    }

    function buildQuestionOptions() {
      const opts = [{ value: "", label: "— siempre mostrar esta pregunta —" }];
      questions.forEach(q => {
        opts.push({ value: String(q.id), label: q.text || q.slug || "pregunta" });
      });
      return opts;
    }

    function createSelect(options, current) {
      const sel = document.createElement("select");
      sel.className = "vTextField";
      options.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        if (String(o.value) === String(current || "")) opt.selected = true;
        sel.appendChild(opt);
      });
      return sel;
    }

    function labeledField(labelText, selectEl) {
      const wrap = document.createElement("label");
      wrap.style.display = "grid";
      wrap.style.gap = "4px";
      wrap.style.flex = "1";

      const label = document.createElement("span");
      label.textContent = labelText;
      label.style.fontSize = "12px";
      label.style.color = "#555";
      label.style.fontWeight = "600";

      wrap.appendChild(label);
      wrap.appendChild(selectEl);
      return wrap;
    }

    function renderRow(cond) {
      const row = document.createElement("div");
      row.setAttribute("data-cond-row", "1");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.flexWrap = "wrap";
      row.style.alignItems = "flex-end";
      row.style.padding = "8px";
      row.style.border = "1px solid #ddd";
      row.style.borderRadius = "8px";

      const qSelect = createSelect(buildQuestionOptions(), cond.question_id || "");
      const valSelect = createSelect(buildValueOptions(null), cond.value || "");
      qSelect.setAttribute("data-cond-question", "1");
      valSelect.setAttribute("data-cond-value", "1");

      function refreshValueOptions(selected) {
        const q = questions.find(x => String(x.id) === String(qSelect.value));
        const opts = buildValueOptions(q);
        valSelect.innerHTML = "";
        opts.forEach(o => {
          const opt = document.createElement("option");
          opt.value = o.value;
          opt.textContent = o.label;
          if (String(o.value) === String(selected || "")) opt.selected = true;
          valSelect.appendChild(opt);
        });
      }

      qSelect.addEventListener("change", () => {
        refreshValueOptions("");
        sync();
      });
      valSelect.addEventListener("change", sync);

      const qField = labeledField("si la respuesta de esta pregunta...", qSelect);
      const vField = labeledField("...es esta respuesta", valSelect);
      row.appendChild(qField);
      row.appendChild(vField);

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "button";
      removeBtn.textContent = "quitar";
      removeBtn.style.marginLeft = "auto";
      removeBtn.addEventListener("click", () => {
        row.remove();
        if (!rows.querySelector("[data-cond-row='1']")) {
          renderRow({ question_id: "", value: "" });
        }
        sync();
      });
      row.appendChild(removeBtn);

      rows.appendChild(row);

      refreshValueOptions(cond.value || "");
    }

    function sync() {
      const data = [];
      rows.querySelectorAll("[data-cond-row='1']").forEach(r => {
        const qSel = r.querySelector("select[data-cond-question='1']");
        const vSel = r.querySelector("select[data-cond-value='1']");
        if (!qSel || !vSel) return;
        const qid = qSel.value;
        const val = vSel.value;
        if (qid && val) data.push({ question_id: Number(qid), value: val });
      });
      input.value = JSON.stringify(data);
    }

    function init() {
      let data = parseAttrJSON(input.value || "[]", []);
      if (!Array.isArray(data)) data = [];
      if (!data.length) data = [{ question_id: "", value: "" }];
      rows.innerHTML = "";
      data.forEach(renderRow);
      sync();
    }

    const addButton = root.querySelector("[data-add-cond]");
    if (addButton) {
      addButton.addEventListener("click", () => {
        renderRow({ question_id: "", value: "" });
        sync();
      });
    }

    init();
  })();
</script>
