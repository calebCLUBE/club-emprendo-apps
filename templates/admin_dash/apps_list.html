{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="ce-admin-wrap">

  <h1>Master Applications</h1>

  <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:24px;">
    {% for fd in masters %}
      <div style="display:flex; flex-direction:column; gap:8px;">
        <a class="ce-admin-tile" href="/admin/applications/formdefinition/{{ fd.id }}/change/">
          <div class="ce-admin-tile-title">{{ fd.slug }}</div>
          <div class="ce-admin-tile-sub">{{ fd.name }}</div>
        </a>

        {% if fd.slug and "_A2" in fd.slug %}
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            {# REAL SEND #}
            <form method="post" action="{% url 'admin_send_second_stage_reminders' fd.slug %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="button"
                onclick="return confirm('Send reminders for {{ fd.slug }} to ALL eligible people?');">
                Send A2 reminders
              </button>
            </form>

            {# TEST ONLY (you type your email) #}
            <form method="post" action="{% url 'admin_send_second_stage_reminders' fd.slug %}" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="test_only" value="1">
              <input type="email" name="test_email" placeholder="your@email.com"
                     style="padding:6px 8px; border:1px solid #ccc; border-radius:6px;" required>
              <button type="submit" class="button">
                Send TEST (only this email)
              </button>
            </form>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p>No master forms found yet.</p>
    {% endfor %}
  </div>

  <hr style="margin:24px 0;" />

  <h2>Groups</h2>

  <div style="margin-bottom: 18px;">
    <form method="post" action="{% url 'admin_create_group' %}">
      {% csrf_token %}

      {% if create_group_form.non_field_errors %}
        <div class="errornote">
          {{ create_group_form.non_field_errors }}
        </div>
      {% endif %}

      {{ create_group_form.as_p }}

      <button type="submit" class="default">Create group</button>
    </form>
  </div>

  {% for g, forms in group_list %}

    <div style="border:1px solid #ddd; border-radius:10px; padding:14px; margin:14px 0; background:#fff;">

      <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          {% if g.number %}
            <h3 style="margin:0;">
              Group {{ g.number }}
              <small style="color:#666; font-weight:normal;">
                ({{ g.start_month }} – {{ g.end_month }} {{ g.year }})
              </small>
            </h3>
          {% else %}
            <h3 style="margin:0;">
              Group {{ g }}
              <small style="color:#b45309; font-weight:normal;">
                (orphan group – missing FormGroup dates)
              </small>
            </h3>
          {% endif %}
        </div>

        <div>
          <form
            method="post"
            action="{% url 'admin_delete_group' group_num=g.number|default:g %}"
            style="display:inline;"
            onsubmit="return confirm('Delete Group {{ g.number|default:g }} and ALL its forms? This cannot be undone.');"
          >
            {% csrf_token %}
            <button type="submit" class="deletelink">Delete group</button>
          </form>
        </div>
      </div>

      {% if forms %}
        <ul style="margin-top:10px;">
          {% for fd in forms %}
            <li style="margin:6px 0;">
              <strong>{{ fd.slug }}</strong>
              — {{ fd.name }}
              &nbsp;|&nbsp;
              <a href="/admin/applications/formdefinition/{{ fd.id }}/change/">Edit</a>

              &nbsp;|&nbsp;
              <a href="/apply/{{ fd.slug }}/" target="_blank" rel="noopener">Open link</a>

              {% if fd.slug and "_A2" in fd.slug %}
                &nbsp;|&nbsp;

                {# REAL SEND #}
                <form method="post" action="{% url 'admin_send_second_stage_reminders' fd.slug %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="button"
                    onclick="return confirm('Send reminders for {{ fd.slug }} to ALL eligible people?');">
                    Send A2 reminders
                  </button>
                </form>

                {# TEST SEND #}
                <form method="post" action="{% url 'admin_send_second_stage_reminders' fd.slug %}" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="test_only" value="1">
                  <input type="email" name="test_email" placeholder="your@email.com"
                         style="padding:4px 6px; border:1px solid #ccc; border-radius:6px;" required>
                  <button type="submit" class="button">
                    TEST
                  </button>
                </form>
              {% endif %}

              <div style="color:#666; font-size:12px; margin-top:2px;">
                Copy/paste: <code>{{ request.scheme }}://{{ request.get_host }}/apply/{{ fd.slug }}/</code>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p style="margin:10px 0 0;"><em>No forms in this group yet.</em></p>
      {% endif %}
    </div>

  {% empty %}
    <p>No groups yet.</p>
  {% endfor %}

</div>
{% endblock %}
