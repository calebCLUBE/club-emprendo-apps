<div>
  {% if sections %}
    <ul style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px;">
      {% for s in sections %}
        <li style="border:1px solid rgba(0,0,0,0.06); border-radius:10px; padding:10px; background:#fafafa;">
          <form
            hx-post="{% url 'builder:section_update' s.id %}"
            hx-target="#section-list"
            hx-swap="innerHTML"
          >
            {% csrf_token %}
            <div style="display:flex; gap:8px; align-items:center;">
              <input class="ce-input" name="title" value="{{ s.title }}" style="flex:1;" />
              <input type="number" class="ce-input" name="position" value="{{ s.position }}" style="width:80px;" min="0" />
              <button class="ce-btn" type="submit">Guardar</button>
              <button class="ce-btn ce-btn-danger"
                      type="button"
                      hx-post="{% url 'builder:section_delete' s.id %}"
                      hx-target="#section-list"
                      hx-swap="innerHTML"
                      hx-confirm="¿Eliminar esta sección? Las preguntas se mantendrán sin sección.">
                ✕
              </button>
            </div>
            <textarea class="ce-input" name="description" rows="2" style="margin-top:8px;">{{ s.description }}</textarea>
            {% with conds=s.show_if_conditions|default:[] %}
              {% if not conds %}
                {% if s.show_if_question_id %}
                  {% with c1={"question_id":s.show_if_question_id,"value":s.show_if_value} %}
                    {% firstof conds.append c1 %}{% endwith %}
                {% endif %}
                {% if s.show_if_question_2_id %}
                  {% with c2={"question_id":s.show_if_question_2_id,"value":s.show_if_value_2} %}
                    {% firstof conds.append c2 %}{% endwith %}
                {% endif %}
              {% endif %}
              <div class="condition-list" data-cond-container>
                {% for c in conds|default_if_none:[] %}
                  <div class="condition-row" style="display:flex; gap:8px; margin-top:8px; align-items:center; flex-wrap:wrap;">
                    <label class="ce-label" style="font-size:12px; margin:0;">Mostrar si</label>
                    <select class="ce-input" name="show_if_question" style="flex:1;" data-show-if-question>
                      <option value="">— Siempre —</option>
                      {% for q in form_def.questions.all %}
                        {% if q.field_type == "boolean" %}
                          <option value="{{ q.id }}"
                                  data-opt-values="yes|no"
                                  data-opt-labels="Sí|No"
                                  {% if c.question_id == q.id %}selected{% endif %}>{{ q.text|default:q.slug }}</option>
                        {% elif q.field_type == "choice" or q.field_type == "multi_choice" %}
                          <option value="{{ q.id }}"
                                  data-opt-values="{% for ch in q.choices.all %}{{ ch.value }}{% if not forloop.last %}|{% endif %}{% endfor %}"
                                  data-opt-labels="{% for ch in q.choices.all %}{{ ch.label|default:ch.value }}{% if not forloop.last %}|{% endif %}{% endfor %}"
                                  {% if c.question_id == q.id %}selected{% endif %}>{{ q.text|default:q.slug }}</option>
                        {% else %}
                          <option value="{{ q.id }}"
                                  data-opt-values=""
                                  data-opt-labels=""
                                  {% if c.question_id == q.id %}selected{% endif %}>{{ q.text|default:q.slug }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                    <select class="ce-input" name="show_if_value" style="flex:1;" data-show-if-value data-current="{{ c.value }}">
                      <option value="">Selecciona valor</option>
                    </select>
                  </div>
                {% endfor %}
              </div>
              <button type="button" class="ce-btn" data-add-cond style="margin-top:8px;">+ Añadir condición</button>
            {% endwith %}
            {% include "builder/partials/section_condition_help.html" %}
            <div class="ce-muted" style="font-size:12px; margin-top:6px;">
              {{ s.questions.count }} preguntas
            </div>
          </form>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="ce-muted" style="margin:0;">No hay secciones. Agrega una para dividir el formulario.</p>
  {% endif %}
</div>
