{# applications/templates/applications/application_form.html #}
{% extends "applications/base.html" %}

{% block title %}{{ form_def.name }} ¬∑ Club Emprendo{% endblock %}

{% block content %}

  {% if rendered_description %}
    <div class="form-intro">
      {{ rendered_description|linebreaks }}
    </div>
  {% endif %}

  <div class="ce-form-header">
    <span class="ce-form-pill">
      {% if second_stage %}Paso 2{% else %}Paso 1{% endif %}
    </span>

    <h1 class="ce-form-title ce-heading">{{ form_def.name }}</h1>
    {% if form_def.description %}
      <p class="ce-form-subtitle">{{ form_def.description }}</p>
    {% endif %}
  </div>

  {% if second_stage %}
    <div class="ce-alert">
      ‚úÖ Recuerda hacer clic en ‚ÄúEnviar / Submit‚Äù al final para registrar tu respuesta.
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}

    {% for field in form %}

      {# ---------- PRE-TEXT / HR ABOVE ANY QUESTION ---------- #}
      {% if field.field.widget.attrs.pre_hr %}
        <hr style="margin:18px 0 10px 0; border:none; border-top:1px solid rgba(0,0,0,.10);">
      {% endif %}

      {% if field.field.widget.attrs.pre_text %}
        <div style="margin:0 0 10px 0; color:#555; line-height:1.45;">
          {{ field.field.widget.attrs.pre_text|linebreaks }}
        </div>
      {% endif %}

      {# ---------- SPECIAL GRID RENDER FOR schedule question ---------- #}
      {% if field.name == "q_preferred_schedule" or field.name == "q_e2_preferred_schedule" or field.name == "q_m2_preferred_schedule" or "¬øEn qu√© horario te resulta m√°s conveniente participar en sesiones virtuales" in field.label|default_if_none:"" %}

        <div class="form-row" data-field="{{ field.name }}">
          <label {% if field.field.required %}class="required"{% endif %}>
            {{ field.label }}
          </label>

          {% if field.help_text %}
            <span class="form-help">{{ field.help_text|safe }}</span>
          {% endif %}

          <div style="overflow:auto; border:1px solid #e9e9e9; border-radius:12px; padding:10px;">
            <table style="border-collapse:collapse; width:100%; min-width:760px; font-size:14px;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;"></th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Lunes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Martes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Mi√©rcoles</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Jueves</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Viernes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">S√°bado</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Domingo</th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Ma√±ana</th>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "mon_morning" or w.choice_label|default:"" == "Lunes - Ma√±ana" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "tue_morning" or w.choice_label|default:"" == "Martes - Ma√±ana" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "wed_morning" or w.choice_label|default:"" == "Mi√©rcoles - Ma√±ana" or w.choice_label|default:"" == "Miercoles - Ma√±ana" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "thu_morning" or w.choice_label|default:"" == "Jueves - Ma√±ana" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "fri_morning" or w.choice_label|default:"" == "Viernes - Ma√±ana" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "sat_morning" or w.choice_label|default:"" == "S√°bado - Ma√±ana" or w.choice_label|default:"" == "Sabado - Ma√±ana" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "sun_morning" or w.choice_label|default:"" == "Domingo - Ma√±ana" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>
                </tr>

                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Tarde</th>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "mon_afternoon" or w.choice_label|default:"" == "Lunes - Tarde" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "tue_afternoon" or w.choice_label|default:"" == "Martes - Tarde" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "wed_afternoon" or w.choice_label|default:"" == "Mi√©rcoles - Tarde" or w.choice_label|default:"" == "Miercoles - Tarde" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "thu_afternoon" or w.choice_label|default:"" == "Jueves - Tarde" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "fri_afternoon" or w.choice_label|default:"" == "Viernes - Tarde" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "sat_afternoon" or w.choice_label|default:"" == "S√°bado - Tarde" or w.choice_label|default:"" == "Sabado - Tarde" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "sun_afternoon" or w.choice_label|default:"" == "Domingo - Tarde" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>
                </tr>

                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Noche</th>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "mon_night" or w.choice_label|default:"" == "Lunes - Noche" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "tue_night" or w.choice_label|default:"" == "Martes - Noche" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "wed_night" or w.choice_label|default:"" == "Mi√©rcoles - Noche" or w.choice_label|default:"" == "Miercoles - Noche" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "thu_night" or w.choice_label|default:"" == "Jueves - Noche" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "fri_night" or w.choice_label|default:"" == "Viernes - Noche" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "sat_night" or w.choice_label|default:"" == "S√°bado - Noche" or w.choice_label|default:"" == "Sabado - Noche" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}
                      {% if w.data.value == "sun_night" or w.choice_label|default:"" == "Domingo - Noche" %}
                        {{ w.tag }}
                      {% endif %}
                    {% endfor %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          {% if field.errors %}
            <span class="form-help" style="color:#d14b4b;">
              {{ field.errors|striptags }}
            </span>
          {% endif %}
        </div>

      {% else %}

        <div class="form-row" data-field="{{ field.name }}">
          <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required"{% endif %}>
            {{ field.label }}
          </label>

          {% if field.help_text %}
            <span class="form-help">{{ field.help_text|safe }}</span>
          {% endif %}

          {{ field }}

          {% if field.errors %}
            <span class="form-help" style="color:#d14b4b;">
              {{ field.errors|striptags }}
            </span>
          {% endif %}
        </div>

      {% endif %}

    {% endfor %}

    <div class="ce-actions">
      <button type="submit" class="ce-button-primary">Enviar</button>
    </div>
  </form>

  <script>
    (function () {
      // üîí Run ONLY for Mentora A2
      if (!window.location.pathname.includes("_M_A2")) return;

      const DRIVER_TEXT = "has dirigido tu propio negocio";
      const TARGET_TEXTS = [
        "industria de tu emprendimiento",
        "nombre de tu emprendimiento",
        "donde operas tu negocio",
        "cuanto tiempo has estado operando",
        "tienes empleados",
        "Descripci√≥n del negocio"
      ];

      function norm(s) {
        return (s || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function findRowByLabelContains(fragment) {
        const frag = norm(fragment);
        const rows = document.querySelectorAll(".form-row");
        for (const row of rows) {
          const label = row.querySelector("label");
          const txt = norm(label ? label.textContent : "");
          if (txt.includes(frag)) return row;
        }
        return null;
      }

      function findRowsByLabelFragments(fragments) {
        const rows = [];
        const all = document.querySelectorAll(".form-row");
        for (const row of all) {
          const label = row.querySelector("label");
          const txt = norm(label ? label.textContent : "");
          for (const f of fragments) {
            if (txt.includes(norm(f))) {
              rows.push(row);
            }
          }
        }
        return rows;
      }

      function getSelectedChoiceText(row) {
        if (!row) return "";

        const sel = row.querySelector("select");
        if (sel) {
          const opt = sel.options[sel.selectedIndex];
          return opt ? opt.textContent.trim() : "";
        }

        const checked = row.querySelector('input[type="radio"]:checked');
        if (checked) {
          const label = checked.closest("label");
          if (label) {
            const clone = label.cloneNode(true);
            clone.querySelectorAll("input").forEach(el => el.remove());
            return clone.textContent.trim();
          }
        }
        return "";
      }

      const driverRow = findRowByLabelContains(DRIVER_TEXT);
      const targetRows = findRowsByLabelFragments(TARGET_TEXTS);

      if (!driverRow || !targetRows.length) return;

      function update() {
        const picked = norm(getSelectedChoiceText(driverRow));
        const show = picked.startsWith("si");
        targetRows.forEach(row => {
          row.style.display = show ? "" : "none";
        });
      }

      update();

      driverRow.querySelectorAll('input[type="radio"]').forEach(el => {
        el.addEventListener("change", update);
      });

      const sel = driverRow.querySelector("select");
      if (sel) sel.addEventListener("change", update);
    })();

    (function () {
      const FOLLOW_TEXT_FRAGMENT = "por favor ind√≠canos qu√© requisito";
      const REQUIREMENTS_SLUG_CANDIDATES = [
        "meets_requirements",
        "m1_meet_requirements",
        "m1_meets_requirements",
        "m1_requirements_ok",
        "requirements_ok",
        "requisitos",
        "requisitos_ok",
      ];

      function norm(s) {
        return (s || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function findRowByLabelContains(fragment) {
        const frag = norm(fragment);
        const rows = document.querySelectorAll(".form-row");
        for (const row of rows) {
          const label = row.querySelector("label");
          const txt = norm(label ? label.textContent : "");
          if (txt.includes(frag)) return row;
        }
        return null;
      }

      function findRowByQuestionSlugCandidates(slugs) {
        for (const slug of slugs) {
          const fieldName = "q_" + slug;

          const byDataField = document.querySelector('.form-row[data-field="' + fieldName + '"]');
          if (byDataField) return byDataField;

          const byName = document.querySelector('.form-row [name="' + fieldName + '"]');
          if (byName) return byName.closest(".form-row");
        }
        return null;
      }

      function setRowVisible(row, show) {
        if (!row) return;
        row.style.display = show ? "" : "none";
      }

      function getSelectedChoiceText(row) {
        if (!row) return "";

        const sel = row.querySelector("select");
        if (sel) {
          const opt = sel.options[sel.selectedIndex];
          return opt ? (opt.textContent || "").trim() : "";
        }

        const checked = row.querySelector('input[type="radio"]:checked');
        if (checked) {
          const choiceLabel = checked.closest("label");
          if (choiceLabel) {
            const clone = choiceLabel.cloneNode(true);
            clone.querySelectorAll("input").forEach(el => el.remove());
            return (clone.textContent || "").trim();
          }
        }

        return "";
      }

      const followRow = findRowByLabelContains(FOLLOW_TEXT_FRAGMENT);
      if (!followRow) return;

      let reqRow = findRowByQuestionSlugCandidates(REQUIREMENTS_SLUG_CANDIDATES);
      if (!reqRow) reqRow = findRowByLabelContains("cumples todos estos requisitos");

      function update() {
        let showFollow = false;
        if (reqRow) {
          const picked = norm(getSelectedChoiceText(reqRow));
          showFollow = picked.startsWith("no");
        }
        setRowVisible(followRow, showFollow);
      }

      update();

      if (reqRow) {
        reqRow.querySelectorAll('input[type="radio"]').forEach((el) => {
          el.addEventListener("change", update);
        });
        const sel = reqRow.querySelector("select");
        if (sel) sel.addEventListener("change", update);
      }
    })();
  </script>

{% endblock %}
