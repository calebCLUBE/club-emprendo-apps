{% extends "applications/base.html" %}
{% block content %}

<script src="https://unpkg.com/htmx.org@1.9.12"></script>
{% load static %}

<div style="display:grid; grid-template-columns: 340px 1fr; gap: 18px;">
  <div style="display:flex; flex-direction:column; gap:14px;">
    <!-- Form header -->
    <div class="ce-card">
      <div>
        <div class="ce-muted" style="font-size:12px;">Editando</div>
        <div style="font-weight:800;">{{ form_def.slug }} — {{ form_def.name }}</div>
      </div>
    </div>

    <!-- Sections -->
    <div class="ce-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="ce-muted" style="font-size:12px;">Secciones</div>
          <div style="font-weight:700;">Divide el formulario en pasos</div>
        </div>
        <button class="ce-btn"
                hx-post="{% url 'builder:section_add' form_def.id %}"
                hx-target="#section-list"
                hx-swap="innerHTML">
          + Agregar sección
        </button>
      </div>

      <div id="section-list" style="margin-top:12px;">
        {% include "builder/partials/section_list.html" %}
      </div>

      <div style="margin-top:14px;">
        <label class="ce-label" style="font-size:12px;">Título para preguntas sin sección</label>
        <input class="ce-input"
               name="default_section_title"
               value="{{ form_def.default_section_title }}"
               hx-post="{% url 'builder:update_default_section_title' form_def.id %}"
               hx-trigger="change"
               hx-swap="none" />
        <div class="ce-muted" style="font-size:12px; margin-top:4px;">
          Se usa para la página que contiene preguntas sin sección asignada.
        </div>
      </div>
    </div>

    <!-- Left: question list -->
    <div class="ce-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="ce-muted" style="font-size:12px;">Preguntas</div>
          <div style="font-weight:700;">Asigna cada pregunta a una sección</div>
        </div>

        <button class="ce-btn"
                hx-post="{% url 'builder:question_add' form_def.id %}"
                hx-target="#question-list"
                hx-swap="innerHTML">
          + Agregar
        </button>
      </div>

      <div id="question-list"
           style="margin-top:14px;"
           hx-get="{% url 'builder:question_list' form_def.id %}"
           hx-trigger="section-changed from:body">
        {% include "builder/partials/question_list.html" %}
      </div>
    </div>
  </div>

  <!-- Right: editor panel -->
  <div class="ce-card">
    <div id="editor-panel">
      <p class="ce-muted">Haz clic en una pregunta a la izquierda para editarla.</p>
    </div>
  </div>
</div>

<script src="{% static 'builder/section_conditions.js' %}"></script>
<script>
  // Fallback / ensure init even if static caching fails
  (function () {
    function updateValueSelect(sel) {
      const form = sel.closest("form");
      if (!form) return;
      const valueSelect = form.querySelector("[data-show-if-value]");
      if (!valueSelect) return;
      const opt = sel.options[sel.selectedIndex];
      const vals = (opt?.dataset.optValues || "").split("|").filter(Boolean);
      const labels = (opt?.dataset.optLabels || "").split("|").filter(Boolean);
      const current = (valueSelect.dataset.current || valueSelect.value || "").toLowerCase();
      valueSelect.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = "Selecciona valor";
      valueSelect.appendChild(ph);
      valueSelect.disabled = vals.length === 0;
      vals.forEach((v, idx) => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = labels[idx] || v;
        if (v.toLowerCase() === current) o.selected = true;
        valueSelect.appendChild(o);
      });
    }
    function init(root) {
      (root || document).querySelectorAll("[data-show-if-question]").forEach((sel) => {
        sel.removeEventListener("change", sel._ce_cond_handler || (()=>{}));
        sel._ce_cond_handler = () => updateValueSelect(sel);
        sel.addEventListener("change", sel._ce_cond_handler);
        updateValueSelect(sel);
      });
    }
    document.addEventListener("DOMContentLoaded", () => init(document));
    if (window.htmx) {
      document.body.addEventListener("htmx:afterSwap", (e) => init(e.target));
    }
    window.ceInitSectionConditions = init;
  })();
</script>

{% endblock %}
