{# applications/templates/applications/application_form.html #}
{% extends "applications/base.html" %}

{% block title %}{{ form_def.name }} · Club Emprendo{% endblock %}

{% block role_chips %}
  {% if form_def.slug|slice:":1" == "E" %}
    <span class="ce-chip">Emprendedoras</span>
  {% elif form_def.slug|slice:":1" == "M" %}
    <span class="ce-chip">Mentoras</span>
  {% else %}
    {{ block.super }}
  {% endif %}
{% endblock %}

{% block content %}

  {% if rendered_description %}
    <div class="form-intro">
      {{ rendered_description|linebreaks }}
    </div>
  {% endif %}

  <div class="ce-form-header">
    <span class="ce-form-pill">
      {% if second_stage %}
        Paso 2 · Aplicación detallada
      {% else %}
        Paso 1 · Aplicación inicial
      {% endif %}
    </span>

    <h1 class="ce-form-title ce-heading">{{ form_def.name }}</h1>

    <p class="ce-form-subtitle">
      {% if second_stage %}
        Esta es la segunda parte del proceso de selección. Tómate tu tiempo para
        responder con calma; tus respuestas nos ayudan a conectar mejor mentoras
        y emprendedoras.
      {% else %}
        Cuéntanos un poco sobre ti y confirma si cumples con los requisitos del
        programa.
      {% endif %}
    </p>
  </div>

  {% if second_stage %}
    <div class="ce-alert">
      Tus datos básicos (nombre y correo) ya están registrados de la primera
      aplicación. Aquí nos enfocamos en conocer mejor tu experiencia,
      motivación y disponibilidad.
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}

    {% for field in form %}

      {# ---------- SPECIAL GRID RENDER FOR preferred_schedule ---------- #}
      {# Works for older slug (q_preferred_schedule) AND new E2/M2 slugs #}
      {% if field.name == "q_preferred_schedule" or field.name == "q_e2_preferred_schedule" or field.name == "q_m2_preferred_schedule" %}

        <div class="form-row">
          <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required"{% endif %}>
            {{ field.label }}
          </label>

          {% if field.help_text %}
            <span class="form-help">{{ field.help_text|safe }}</span>
          {% endif %}

          <div style="overflow:auto; border:1px solid #e9e9e9; border-radius:12px; padding:10px;">
            <table style="border-collapse:collapse; width:100%; min-width:760px; font-size:14px;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;"></th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Lunes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Martes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Miércoles</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Jueves</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Viernes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Sábado</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Domingo</th>
                </tr>
              </thead>

              <tbody>
                {# ===== ROW: MAÑANA ===== #}
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Mañana</th>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "mon_morning" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "tue_morning" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "wed_morning" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "thu_morning" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "fri_morning" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "sat_morning" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "sun_morning" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                </tr>

                {# ===== ROW: TARDE ===== #}
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Tarde</th>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "mon_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "tue_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "wed_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "thu_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "fri_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "sat_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "sun_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                </tr>

                {# ===== ROW: NOCHE ===== #}
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Noche</th>

                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "mon_night" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "tue_night" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "wed_night" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "thu_night" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "fri_night" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "sat_night" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">
                    {% for w in field %}{% if w.data.value == "sun_night" %}{{ w.tag }}{% endif %}{% endfor %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          {% if field.errors %}
            <span class="form-help" style="color:#d14b4b;">
              {{ field.errors|striptags }}
            </span>
          {% endif %}
        </div>

      {% else %}

        <div class="form-row">
          <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required"{% endif %}>
            {{ field.label }}
          </label>

          {% if field.help_text %}
            <span class="form-help">{{ field.help_text|safe }}</span>
          {% endif %}

          {# --- SPECIAL RENDER: single checkbox -> show Sí + No checkboxes --- #}
          {% if field.field.widget.input_type == "checkbox" %}
            <div style="display:flex; gap:18px; align-items:center; margin-top:6px;">
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                {{ field }}
                <span>Sí</span>
              </label>

              {# "No" is a UI-only checkbox: when checked, it unchecks the real field #}
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <input
                  type="checkbox"
                  class="ce-no-toggle"
                  data-target="{{ field.id_for_label }}"
                  {% if not field.value %}checked{% endif %}
                >
                <span>No</span>
              </label>
            </div>

            <script>
              (function() {
                // This script runs inline for each checkbox field; safe and small.
                const yes = document.getElementById("{{ field.id_for_label }}");
                if (!yes) return;

                const no = document.querySelector('input.ce-no-toggle[data-target="{{ field.id_for_label }}"]');
                if (!no) return;

                // Initial sync: if "Sí" is checked -> "No" must be off; else "No" on
                function sync() {
                  if (yes.checked) {
                    no.checked = false;
                  } else {
                    no.checked = true;
                  }
                }
                sync();

                yes.addEventListener("change", sync);

                no.addEventListener("change", function() {
                  if (no.checked) {
                    yes.checked = false;
                  } else {
                    // If user unchecks "No", we interpret that as "Sí"
                    yes.checked = true;
                  }
                  sync();
                });
              })();
            </script>
          {% else %}
            {{ field }}
          {% endif %}

          {% if field.errors %}
            <span class="form-help" style="color:#d14b4b;">
              {{ field.errors|striptags }}
            </span>
          {% endif %}
        </div>

      {% endif %}

    {% endfor %}

    <div class="ce-actions">
      <button type="submit" class="ce-button-primary">
        Enviar aplicación
      </button>
    </div>
  </form>

{% endblock %}
