{# applications/templates/applications/application_form.html #}
{% extends "applications/base.html" %}

{% block title %}{{ form_def.name }} · Club Emprendo{% endblock %}

{% block content %}

  {% if rendered_description %}
    <div class="form-intro">
      {{ rendered_description|linebreaks }}
    </div>
  {% endif %}

  <div class="ce-form-header">
    <span class="ce-form-pill">
      {% if second_stage %}
        Paso 2
      {% else %}
        Paso 1
      {% endif %}
    </span>

    <h1 class="ce-form-title ce-heading">{{ form_def.name }}</h1>
    {% if form_def.description %}
      <p class="ce-form-subtitle">{{ form_def.description }}</p>
    {% endif %}
  </div>

  {% if second_stage %}
    <div class="ce-alert">
      ✅ Recuerda hacer clic en “Enviar / Submit” al final para registrar tu respuesta.
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}

    {% for field in form %}

      {# ---------- SPECIAL GRID RENDER FOR preferred_schedule ---------- #}
      {% if field.name == "q_preferred_schedule" or field.name == "q_e2_preferred_schedule" or field.name == "q_m2_preferred_schedule" %}

        <div class="form-row" data-field="{{ field.name }}">
          <label {% if field.field.required %}class="required"{% endif %}>
            {{ field.label }}
          </label>

          {% if field.help_text %}
            <span class="form-help">{{ field.help_text|safe }}</span>
          {% endif %}

          <div style="overflow:auto; border:1px solid #e9e9e9; border-radius:12px; padding:10px;">
            <table style="border-collapse:collapse; width:100%; min-width:760px; font-size:14px;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;"></th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Lunes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Martes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Miércoles</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Jueves</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Viernes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Sábado</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Domingo</th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Mañana</th>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "mon_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "tue_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "wed_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "thu_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "fri_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sat_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sun_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                </tr>

                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Tarde</th>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "mon_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "tue_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "wed_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "thu_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "fri_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sat_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sun_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                </tr>

                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Noche</th>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "mon_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "tue_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "wed_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "thu_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "fri_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sat_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sun_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                </tr>
              </tbody>
            </table>
          </div>

          {% if field.errors %}
            <span class="form-help" style="color:#d14b4b;">
              {{ field.errors|striptags }}
            </span>
          {% endif %}
        </div>

      {% else %}

        <div class="form-row" data-field="{{ field.name }}">
          <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required"{% endif %}>
            {{ field.label }}
          </label>

          {% if field.help_text %}
            <span class="form-help">{{ field.help_text|safe }}</span>
          {% endif %}

          {{ field }}

          {% if field.errors %}
            <span class="form-help" style="color:#d14b4b;">
              {{ field.errors|striptags }}
            </span>
          {% endif %}
        </div>

      {% endif %}
    {% endfor %}

    <div class="ce-actions">
      <button type="submit" class="ce-button-primary">Enviar</button>
    </div>
  </form>

  <script>
    (function () {
      // Follow-up row (the textarea)
      const FOLLOW_TEXT_FRAGMENT = "por favor indícanos qué requisito";

      // Requirements question: try to find by slug candidates first (works even if label differs)
      const REQUIREMENTS_SLUG_CANDIDATES = [
        "meets_requirements",
        "m1_meet_requirements",
        "m1_meets_requirements",
        "m1_requirements_ok",
        "requirements_ok",
        "requisitos",
        "requisitos_ok",
      ];

      function norm(s) {
        return (s || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "") // remove accents
          .replace(/\s+/g, " ")
          .trim();
      }

      function findRowByLabelContains(fragment) {
        const frag = norm(fragment);
        const rows = document.querySelectorAll(".form-row");
        for (const row of rows) {
          const label = row.querySelector("label");
          const txt = norm(label ? label.textContent : "");
          if (txt.includes(frag)) return row;
        }
        return null;
      }

      function findRowByQuestionSlugCandidates(slugs) {
        // Your template renders: <div class="form-row" data-field="{{ field.name }}">
        // Field names are q_<slug>
        for (const slug of slugs) {
          const fieldName = "q_" + slug;

          // Primary: data-field match
          const byDataField = document.querySelector('.form-row[data-field="' + fieldName + '"]');
          if (byDataField) return byDataField;

          // Fallback: input/select name match
          const byName = document.querySelector('.form-row [name="' + fieldName + '"]');
          if (byName) return byName.closest(".form-row");
        }
        return null;
      }

      function setRowVisible(row, show) {
        if (!row) return;
        row.style.display = show ? "" : "none";
      }

      // Get selected choice text whether rendered as radios OR a select dropdown
      function getSelectedChoiceText(row) {
        if (!row) return "";

        // Case 1: <select>
        const sel = row.querySelector("select");
        if (sel) {
          const opt = sel.options[sel.selectedIndex];
          return opt ? (opt.textContent || "").trim() : "";
        }

        // Case 2: radios
        const checked = row.querySelector('input[type="radio"]:checked');
        if (checked) {
          const choiceLabel = checked.closest("label");
          if (choiceLabel) {
            const clone = choiceLabel.cloneNode(true);
            clone.querySelectorAll("input").forEach(el => el.remove());
            return (clone.textContent || "").trim();
          }
        }

        return "";
      }

      // Find follow-up row
      const followRow = findRowByLabelContains(FOLLOW_TEXT_FRAGMENT);
      if (!followRow) return; // don't hide random things if we can't find it

      // Find requirements row: slug-based first, label fallback
      let reqRow = findRowByQuestionSlugCandidates(REQUIREMENTS_SLUG_CANDIDATES);
      if (!reqRow) {
        reqRow = findRowByLabelContains("cumples todos estos requisitos");
      }

      function update() {
        let showFollow = false;

        // Default: hidden unless explicitly "No"
        if (reqRow) {
          const picked = norm(getSelectedChoiceText(reqRow));
          showFollow = picked.startsWith("no");
        }

        setRowVisible(followRow, showFollow);
      }

      // Initial
      update();

      // Listen for changes (radios OR select)
      if (reqRow) {
        reqRow.querySelectorAll('input[type="radio"]').forEach((el) => {
          el.addEventListener("change", update);
        });

        const sel = reqRow.querySelector("select");
        if (sel) sel.addEventListener("change", update);
      }
    })();
  </script>

{% endblock %}
