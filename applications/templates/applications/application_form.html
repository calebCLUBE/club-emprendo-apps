{# applications/templates/applications/application_form.html #}
{% extends "applications/base.html" %}

{% block title %}{{ form_def.name }} · Club Emprendo{% endblock %}

{% block role_chips %}
  {% if form_def.slug|slice:":1" == "E" %}
    <span class="ce-chip">Emprendedoras</span>
  {% elif form_def.slug|slice:":1" == "M" %}
    <span class="ce-chip">Mentoras</span>
  {% else %}
    {{ block.super }}
  {% endif %}
{% endblock %}

{% block content %}

  {% if rendered_description %}
    <div class="form-intro">
      {{ rendered_description|linebreaks }}
    </div>
  {% endif %}

  <div class="ce-form-header">
    <span class="ce-form-pill">
      {% if second_stage %}
        Paso 2 · Aplicación detallada
      {% else %}
        Paso 1 · Aplicación inicial
      {% endif %}
    </span>

    <h1 class="ce-form-title ce-heading">{{ form_def.name }}</h1>

    <p class="ce-form-subtitle">
      {% if second_stage %}
        Esta es la segunda parte del proceso de selección. Tómate tu tiempo para
        responder con calma; tus respuestas nos ayudan a conectar mejor mentoras
        y emprendedoras.
      {% else %}
        Cuéntanos un poco sobre ti y confirma si cumples con los requisitos del
        programa.
      {% endif %}
    </p>
  </div>

  {% if second_stage %}
    <div class="ce-alert">
      Tus datos básicos (nombre y correo) ya están registrados de la primera
      aplicación. Aquí nos enfocamos en conocer mejor tu experiencia,
      motivación y disponibilidad.
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}

    {% for field in form %}

      {# ---------- SPECIAL GRID RENDER FOR preferred_schedule ---------- #}
      {% if field.name == "q_preferred_schedule" or field.name == "q_e2_preferred_schedule" or field.name == "q_m2_preferred_schedule" %}

        <div class="form-row">
          <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required"{% endif %}>
            {{ field.label }}
          </label>

          {% if field.help_text %}
            <span class="form-help">{{ field.help_text|safe }}</span>
          {% endif %}

          <div style="overflow:auto; border:1px solid #e9e9e9; border-radius:12px; padding:10px;">
            <table style="border-collapse:collapse; width:100%; min-width:760px; font-size:14px;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;"></th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Lunes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Martes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Miércoles</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Jueves</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Viernes</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Sábado</th>
                  <th style="text-align:center; padding:10px; border-bottom:1px solid #eee;">Domingo</th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Mañana</th>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "mon_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "tue_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "wed_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "thu_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "fri_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sat_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sun_morning" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                </tr>

                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Tarde</th>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "mon_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "tue_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "wed_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "thu_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "fri_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sat_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sun_afternoon" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                </tr>

                <tr>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #f0f0f0;">Noche</th>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "mon_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "tue_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "wed_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "thu_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "fri_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sat_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                  <td style="text-align:center; padding:10px; border-bottom:1px solid #f0f0f0;">{% for w in field %}{% if w.data.value == "sun_night" %}{{ w.tag }}{% endif %}{% endfor %}</td>
                </tr>
              </tbody>
            </table>
          </div>

          {% if field.errors %}
            <span class="form-help" style="color:#d14b4b;">
              {{ field.errors|striptags }}
            </span>
          {% endif %}
        </div>

      {% else %}

        {# ---------- CONDITIONAL: only show comments when meets_requirements == "no" ---------- #}
        {% if field.name == "q_comments" or field.name == "q_comments_if_not_eligible" %}
          <div class="form-row"
               data-conditional="1"
               data-show-when="q_meets_requirements"
               data-show-value="no"
               style="display:none;">
            <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required"{% endif %}>
              {{ field.label }}
            </label>

            {% if field.help_text %}
              <span class="form-help">{{ field.help_text|safe }}</span>
            {% endif %}

            {{ field }}

            {% if field.errors %}
              <span class="form-help" style="color:#d14b4b;">
                {{ field.errors|striptags }}
              </span>
            {% endif %}
          </div>
        {% else %}

          <div class="form-row">
            <label for="{{ field.id_for_label }}" {% if field.field.required %}class="required"{% endif %}>
              {{ field.label }}
            </label>

            {% if field.help_text %}
              <span class="form-help">{{ field.help_text|safe }}</span>
            {% endif %}

            {{ field }}

            {% if field.errors %}
              <span class="form-help" style="color:#d14b4b;">
                {{ field.errors|striptags }}
              </span>
            {% endif %}
          </div>

        {% endif %}

      {% endif %}
    {% endfor %}

    <div class="ce-actions">
      <button type="submit" class="ce-button-primary">
        Enviar aplicación
      </button>
    </div>
  </form>

  <script>
    (function () {
      function getControllerValue(fieldName) {
        // handles radios (your ChoiceField uses RadioSelect)
        var checked = document.querySelector('input[name="' + fieldName + '"]:checked');
        if (checked) return checked.value;

        // fallback: selects/text inputs
        var el = document.querySelector('[name="' + fieldName + '"]');
        if (!el) return null;
        return el.value;
      }

      function setEnabled(container, enabled) {
        var inputs = container.querySelectorAll('input, textarea, select');
        inputs.forEach(function (el) {
          el.disabled = !enabled;
          if (!enabled) {
            if (el.type === "checkbox" || el.type === "radio") {
              el.checked = false;
            } else {
              el.value = "";
            }
          }
        });
      }

      function applyConditionals() {
        var blocks = document.querySelectorAll('[data-conditional="1"]');
        blocks.forEach(function (block) {
          var controller = block.getAttribute('data-show-when');
          var desired = block.getAttribute('data-show-value');

          var current = getControllerValue(controller);
          var shouldShow = (current === desired);

          block.style.display = shouldShow ? "" : "none";
          setEnabled(block, shouldShow);
        });
      }

      document.addEventListener("change", function (e) {
        // Any change might affect conditions, but controller changes are the main ones
        applyConditionals();
      });

      document.addEventListener("DOMContentLoaded", function () {
        applyConditionals();
      });

      // If this script loads after DOMContentLoaded (common), still run once:
      applyConditionals();
    })();
  </script>

{% endblock %}
